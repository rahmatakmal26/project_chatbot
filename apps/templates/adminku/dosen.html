{% extends 'adminku/base.html' %}

{% block title %}Manage Chatbot Answers{% endblock %}

{% block header %}
<h1>Kelola Dosen</h1>

{% endblock %}

{% block content %}

{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/styleadmin.css' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        #modalImage {
            width: 100vw;
            height: auto;
            max-height: 90vh;
            object-fit: contain; 
        }
        .modal-dialog {
            max-width: 100vw;
            margin: 0;
        }

        table.crud-table td:nth-child(5),
        table.crud-table th:nth-child(5) {
            max-width: 150px;
            word-wrap: break-word;
            white-space: normal;
        }

         .input-valid {
            border-bottom: 2px solid green !important;
        }
        .input-invalid {
            border-bottom: 2px solid red !important;
        }

    </style>



<section class="crud-section">
    <div class="crud-header">
    <h2>Daftar Dosen</h2>
</div>
    <div class="crud-action" style="text-align: right; margin-top: 10px;">
        <button class="btn-add" onclick="openModal()">+ Tambah Dosen</button>
    </div>

     
    <table class="crud-table table table-striped">
        <thead>
            <tr>
                <th>No</th>
                <th>NIP</th>
                <th>Nama Dosen</th>
                <th>Tempat Lahir</th>
                <th>No.HP</th>
                <th>Foto</th>
                <th>Created Time</th>
                <th>Updated Time</th>
                <th>Aksi</th>
            </tr>
            <tr>
                <th></th>
                <th><input type="text" class="form-control filter-input" data-column="0" placeholder="Cari NIP"></th>
                <th><input type="text" class="form-control filter-input" data-column="1" placeholder="Cari Nama Dosen"></th>
                <th><input type="text" class="form-control filter-input" data-column="2" placeholder="Cari Tempat Lahir"></th>
                <th><input type="text" class="form-control filter-input" data-column="3" placeholder="Cari No.HP"></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody id="dosenTableBody">
            <!--AJAX -->
        </tbody>
    </table>

    <nav class="d-flex justify-content-between align-items-center mt-3">
        <div class="form-inline">
            <label for="dataPerPageSelect" class="mr-2">Tampilkan:</label>
            <select id="dataPerPageSelect" class="form-control" onchange="ubahdataPerPage()">
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
            <span class="ml-2"></span>
        </div>
        <ul class="pagination mb-0" id="pagination"></ul>
    </nav>



    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xxl w-100">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="imageModalLabel">Foto Dosen</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
            <img id="modalImage" src="" alt="Foto Dosen" class="img-fluid">
            </div>
        </div>
        </div>
    </div>
   
  
    <div class="modal fade" id="dosenModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <form id="dosenForm" onsubmit="saveDosen(event)">
                {% csrf_token %}
                <input type="hidden" id="is_editing" value="false">

                <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Tambah Dosen</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Tutup">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>

                <div class="modal-body">
                <div class="form-group">
                    <label for="nip">NIP Dosen:</label>
                    <input type="number" class="form-control" id="nip" name="nip" required maxlength="18">
                </div>
                <div class="form-group">
                    <label for="nama">Nama:</label>
                    <input type="text" class="form-control" id="nama" name="nama" required>
                </div>
                <div class="form-group">
                    <label for="tempat_lahir">Tempat Lahir:</label>
                    <input type="text" class="form-control" id="tempat_lahir" name="tempat_lahir" required>
                </div>
                <div class="form-group">
                    <label for="no_hp">No. HP:</label>
                    <input type="number" class="form-control" id="no_hp" name="no_hp" required>
                </div>
                <div class="form-group">
                    <label for="foto">Foto Dosen:</label>
                    <input type="file" class="form-control-file" id="foto" name="foto" accept="image/*">
                    <img id="foto_preview" src="" alt="Preview Foto" class="img-thumbnail mt-2" style="display:none; width: 100px;">
                </div>


                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
            </div>
        </div>
    </div>
       
</section>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/pagination1.js' %}"></script> 


<script>

    $(document).ready(function() {
        fetchDataDosen();

        $('#nip').on('input', function () {
            let value = $(this).val();

            // 18 digit
            if (value.length > 18) {
                value = value.slice(0, 18);
                $(this).val(value);
            }

            const isValid = value.length === 18;
            $(this).removeClass('input-valid input-invalid');

            if (value.length > 0) {
                if (isValid) {
                    $(this).addClass('input-valid');
                } else {
                    $(this).addClass('input-invalid');
                }
            }
        });

        $('#foto').on('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#foto_preview').attr('src', e.target.result).show();
                };
                reader.readAsDataURL(file);
            } else {
                $('#foto_preview').hide();
            }
        });
        
    });
    
    function fetchDataDosen() {
        $.ajax({
            url: '{% url "data-dosen" %}',
            type: 'GET',
            success: function (response) {
                allData = response.data_dosen;
                renderTable();
            },
            error: function (xhr) {
                alert('Error fetching data: ' + xhr.responseText);
            }
        });
    }

    function formatToWIB(datetimeString) {
        const date = new Date(datetimeString);
        return date.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
    }

    function renderTable() {
        const tableBody = $('#dosenTableBody');
        tableBody.empty();

        const filters = $(".filter-input").map(function () {
            return $(this).val().toLowerCase();
        }).get();

        const filteredData = allData.filter((dsn) => {
            const filterMap = {
                0: dsn.nip.toString().toLowerCase(),
                1: dsn.nama.toLowerCase(),
                2: dsn.tempat_lahir.toLowerCase(),
                3: dsn.no_hp.toString().toLowerCase(),
            };
        
            return filters.every((filter, index) => {
                return !filter || filterMap[index].includes(filter);
            });
        });

        const startIndex = (halamanAktif - 1) * dataPerPage;
        const endIndex = startIndex + dataPerPage;
        const paginatedData = filteredData.slice(startIndex, endIndex);

        if (paginatedData.length > 0) {
            paginatedData.forEach((dsn, i) => {
                tableBody.append(`
                    <tr>
                        <td>${startIndex + i + 1}</td>
                        <td>${dsn.nip}</td>
                        <td>${dsn.nama}</td>
                        <td>${dsn.tempat_lahir}</td>
                        <td>${dsn.no_hp}</td>
                        <td>
                            <img src="/media/${dsn.foto}" alt="Foto Dosen" width="50"
                                 onclick="showImageModal('/media/${dsn.foto}')"
                                 style="cursor: pointer;">
                        </td>
                        <td>${formatToWIB(dsn.created_time)}</td>
                        <td>${formatToWIB(dsn.updated_time)}</td>
                        <td>
                            <button onclick="editData('${dsn.nip}', '${dsn.nama}', '${dsn.tempat_lahir}', '${dsn.no_hp}', '${dsn.foto}')" 
                                    class="btn btn-sm btn-primary mx-1" title="Edit">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button onclick="deleteData('${dsn.nip}')" 
                                    class="btn btn-sm btn-danger mx-1" title="Delete">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        } else {
            tableBody.append('<tr><td colspan="9">Tidak ada data.</td></tr>');
        }

        renderPagination(filteredData.length, renderTable);
    }

    
    function saveDosen(event) {
        event.preventDefault();
    
        const isEditing = $('#is_editing').val() === 'true';
        const nip = $('#nip').val();
    
        let url = '{% url "create-dosen" %}';
        let type = 'POST';
    
        if (isEditing) {
            url = `/edit-dosen/${nip}/`;
            type = 'POST'; 
        }
    
        const formData = new FormData();
        formData.append('nip', nip);
        formData.append('nama', $('#nama').val());
        formData.append('tempat_lahir', $('#tempat_lahir').val());
        formData.append('no_hp', $('#no_hp').val());
    
        const foto = $('#foto')[0].files[0];
        if (foto) {
            formData.append('foto', foto);
        }
    
        $.ajax({
            url: url,
            type: type,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                alert(isEditing ? 'Data berhasil diubah!' : 'Data berhasil disimpan!');
                fetchDataDosen();
                closeModal();
            },
            error: function(xhr) {
                alert('Error: ' + xhr.responseText);
            }
        });
    }
    
    
    function editData(nip, nama, tempat_lahir, no_hp, foto) {
        $('#modalTitle').text('Edit Dosen');
        $('#nip').val(nip).prop('readonly', true); 
        $('#nama').val(nama);
        $('#tempat_lahir').val(tempat_lahir);
        $('#no_hp').val(no_hp);

        if (foto) {
            $('#foto_preview').attr('src', `/media/${foto}`).show();
            $('#foto_filename').text(foto).show();
        } else {
            $('#foto_preview').hide();
            $('#foto_filename').hide();
        }

        if (!$('#is_editing').length) {
            $('#dosenForm').append('<input type="hidden" id="is_editing" value="true">');
        } else {
            $('#is_editing').val('true');
        }

        $('#dosenModal').modal('show');
    }

    
    function deleteData(nip) {
        if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
            $.ajax({
                url: `/delete-dosen/${nip}/`,  
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') 
                },
                success: function(response) {
                    alert(response.message); 
                    fetchDataDosen(); 
                },
                error: function(xhr) {
                    alert('Error deleting data: ' + xhr.responseText);
                }
            });
        }
    }
    
  
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function openModal() {
        $('#dosenModal').modal('show');
        $('#nip').val('');
    }


    function closeModal() {
        $('#dosenModal').modal('hide');
        $('#dosenForm')[0].reset();
        $('#nip').prop('readonly', false);
        $('#modalTitle').text('Tambah Dosen');
        $('#foto_preview').hide(); 
        $('#foto_filename').hide(); 
    }

    function showImageModal(imageUrl) {
        $('#modalImage').attr('src', imageUrl);
        $('#imageModal').modal('show');
    }

   $('#dosenModal').on('hidden.bs.modal', function () {
  closeModal(); 
 });



    
</script>    

{% endblock %}
